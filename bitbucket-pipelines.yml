pipelines:
  default:
    - parallel:
        - step:
            name: Validate
            image: hashicorp/terraform
            script:
               - terraform fmt -recursive -check

        - step:
            name: Validate
            image: ubuntu:latest
            trigger: manual
            script:
               - wget "https://github.com/terraform-linters/tflint/releases/latest/download/tflint_linux_amd64.zip" -O tflint.zip
               - unzip tflint.zip && mv tflint /usr/local/bin/ && tflint --version
               - tflint --recursive --config "$(pwd)/.tflint.hcl"

        - step:
            name: Validate
            image: bridgecrew/checkov:latest
            trigger: manual
            script:
              - wget "https://github.com/liamg/tfsec/releases/latest/download/tfsec-linux-amd64" -O tfsec
              - chmod +x tfsec && mv tfsec /usr/local/bin/ && tfsec --version
              - tfsec .

        - step:
            name: Security Scan
            script:
              - pipe: atlassian/git-secrets-scan:0.5.1

  branches:
    master:
      - step:
          oidc: true
          image: amazon/aws-cli
          max-time: 5
          script:
            - echo "role - ${IODC_IAM_ROLE_ARN}"
            - set -- $(aws sts assume-role-with-web-identity
              --role-arn ${IODC_IAM_ROLE_ARN}
              --role-session-name bitbucket-build-session
              --web-identity-token $BITBUCKET_STEP_OIDC_TOKEN
              --duration-seconds 1000
              --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]'
              --output text)

            - export AWS_ACCESS_KEY_ID="$1"
            - export AWS_SECRET_ACCESS_KEY="$2"
            - export AWS_SESSION_TOKEN="$3"
            - export AWS_DEFAULT_REGION="us-east-1"

            - echo -e "Check access from managment account"
            - aws s3 ls

            - echo -e "Assume role from development account"
            - set -- $(aws sts assume-role
              --role-arn arn:aws:iam::935454902317:role/terraform-execution-full-access
              --role-session-name terraform-execution-full-access
              --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]'
              --output text)

            - export AWS_ACCESS_KEY_ID="$1"
            - export AWS_SECRET_ACCESS_KEY="$2"
            - export AWS_SESSION_TOKEN="$3"
            - export AWS_DEFAULT_REGION="us-east-1"
            - aws s3 ls

      - step:
          name: Validate
          image: hashicorp/terraform
          trigger: manual
          script:
            - terraform init --upgrade

      - step:
          name: Deploy to Production
          deployment: Production
          image: hashicorp/terraform
          trigger: manual
          script:
            - terraform init
            - terraform plan
          # - terraform apply -auto-approve
